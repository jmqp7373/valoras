name: ğŸš€ Deploy Valora.vip - Complete Platform

# Despliegue automÃ¡tico cuando hay cambios en main
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy Complete Valora Platform
    
    steps:
    # 1. Checkout del cÃ³digo con toda la nueva funcionalidad
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup PHP Environment
    - name: ğŸ” Setup PHP Environment
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, gd, curl
        
    # 3. Install Composer Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --no-dev --optimize-autoloader --no-interaction
          echo "âœ… Composer dependencies installed"
        else
          echo "â„¹ï¸ No composer.json found, skipping composer install"
        fi
        
    # 4. Validate PHP Syntax and System
    - name: ğŸ§ª Validate Complete System
      run: |
        echo "ğŸ” Validando sintaxis PHP en todo el sistema..."
        find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
        echo "âœ… ValidaciÃ³n de sintaxis completada"
        
        echo "ğŸ“Š EstadÃ­sticas del sistema completo:"
        echo "ğŸ“„ Archivos PHP: $(find . -name '*.php' -not -path './vendor/*' | wc -l)"
        echo "ğŸ¤– Sistema de IA: $(ls -la controllers/login/usernameGenerator.php 2>/dev/null && echo 'Presente' || echo 'No encontrado')"
        echo "ğŸ¯ Wizard IA: $(ls -la views/login/registranteUserAvailavilitySelect.php 2>/dev/null && echo 'Presente' || echo 'No encontrado')"
        echo "ğŸ”‘ Sistema Auth: $(ls -la controllers/login/AuthController.php 2>/dev/null && echo 'Presente' || echo 'No encontrado')"
        echo "ï¿½ Reset Password: $(ls -la controllers/login/PasswordResetController.php 2>/dev/null && echo 'Presente' || echo 'No encontrado')"
        echo "ğŸ‘¥ Panel Admin: $(ls -la views/admin/ 2>/dev/null && echo 'Presente' || echo 'No encontrado')"
        
    # 5. Prepare Complete System for Deployment
    - name: ğŸ“ Prepare Complete Platform
      run: |
        echo "ğŸ“‹ Sistema completo listo para deployment:"
        echo "ğŸ  Estructura principal:"
        ls -la
        echo ""
        echo "ğŸ¯ Controladores:"
        ls -la controllers/login/ 2>/dev/null || echo "âš ï¸ Directorio controllers/login no encontrado"
        echo ""
        echo "ğŸ‘ï¸ Vistas principales:"
        ls -la views/login/ 2>/dev/null || echo "âš ï¸ Directorio views/login no encontrado"
        echo ""
        echo "ğŸ”§ Panel administrativo:"
        ls -la views/admin/ 2>/dev/null || echo "âš ï¸ Directorio views/admin no encontrado"
        
        echo "ğŸ” Verificando estructura MVC:"
        echo "ğŸ“ Controllers: $(ls -1 controllers/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Models: $(ls -1 models/ 2>/dev/null | wc -l) archivos"  
        echo "ğŸ“ Views: $(ls -1 views/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Services: $(ls -1 services/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Config: $(ls -1 config/ 2>/dev/null | wc -l) archivos"
        
        echo "ï¿½ Verificando sistema de email:"
        [ -f "services/EmailService.php" ] && echo "âœ… EmailService.php encontrado" || echo "âŒ EmailService.php faltante"
        [ -f "config/email-config.php" ] && echo "âœ… email-config.php encontrado" || echo "âŒ email-config.php faltante"
        [ -d "vendor" ] && echo "âœ… Dependencias Composer encontradas" || echo "âŒ Directorio vendor faltante"
        
    # 6. Debug - Verificar secretos (sin mostrar valores reales)
    - name: ğŸ” Debug Connection Info
      run: |
        echo "ğŸ” Verificando configuraciÃ³n de deploy..."
        echo "ğŸ“¡ FTP Host configurado: $(echo '${{ secrets.FTP_HOST }}' | sed 's/./*/g')"
        echo "ğŸ‘¤ FTP User configurado: $(echo '${{ secrets.FTP_USERNAME }}' | sed 's/./*/g')"  
        echo "ğŸ” FTP Pass configurado: $(if [ -n '${{ secrets.FTP_PASSWORD }}' ]; then echo '***SET***'; else echo '***NOT SET***'; fi)"
        echo "ï¿½ FTP Port configurado: ${{ secrets.FTP_PORT || 21 }}"
        echo "ï¿½ğŸ“ Directorio destino: /public_html/"
        echo "ğŸŒ Protocolo: FTP"
        
    # 7. Deploy Complete Platform to Hostinger
    - name: ğŸš€ Deploy Complete Platform (FTP)
      id: ftp-deploy
      continue-on-error: true
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: ${{ secrets.FTP_PORT || 21 }}
        local-dir: ./
        server-dir: /public_html/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/vendor/**
          **/.vscode/**
          **/test_*.php
          **/demo_*.php
          **/*.md
          **/README*
          **/.github/**
          **/.env*
          **/.DS_Store
          **/Thumbs.db
          **/*.log
          **/*.bat
          **/*.sh
        dry-run: false

    # 8. VerificaciÃ³n post-deployment
    - name: âœ… Post-Deployment System Check
      if: steps.ftp-deploy.outcome == 'success'
      run: |
        echo "ğŸ‰ Â¡DEPLOYMENT EXITOSO!"
        echo "================================"
        echo "ğŸŒ Sitio Web: https://valora.vip"
        echo "ğŸ” Login: https://valora.vip/views/login/login.php"
        echo "ğŸ“ Registro: https://valora.vip/views/login/register.php"
        echo "ğŸ”‘ Reset Password: https://valora.vip/views/login/password_reset.php"
        echo "ğŸ”§ Panel Admin: https://valora.vip/views/admin/"
        echo "ï¿½ Panel Permisos: https://valora.vip/views/admin/permissionsPanel.php"
        echo "ğŸ” System Check: https://valora.vip/views/checksTests/system-check.php"
        echo "================================"
        echo "âœ… FUNCIONALIDADES DESPLEGADAS:"
        echo "âœ… Sistema de autenticaciÃ³n completo"
        echo "âœ… Panel de permisos con ediciÃ³n inline"
        echo "âœ… Toggle de mÃ³dulos exentos"
        echo "âœ… Sistema de tickets de soporte"
        echo "âœ… RecuperaciÃ³n de contraseÃ±a"
        echo "âœ… Panel administrativo"
        echo "================================"

    # 9. Manejar errores de deployment
    - name: âŒ Handle Deployment Failure
      if: steps.ftp-deploy.outcome == 'failure'
      run: |
        echo "âŒ DEPLOYMENT FALLÃ“"
        echo "================================"
        echo "ğŸ” Possible issues:"
        echo "- Verificar credenciales FTP en GitHub Secrets"
        echo "- Confirmar que el servidor estÃ¡ disponible"
        echo "- Revisar permisos en /public_html/"
        echo "- Verificar que no hay archivos bloqueados"
        echo "================================"
        echo "ğŸ› ï¸ Para debug:"
        echo "1. Ir a GitHub Actions y revisar logs detallados"
        echo "2. Verificar los secrets: FTP_HOST, FTP_USERNAME, FTP_PASSWORD, FTP_PORT"
        echo "3. Probar conexiÃ³n FTP manualmente"
        echo "================================"
        exit 1
        server-dir: /public_html/
        local-dir: ./
        log-level: verbose
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/README.md
          **/.github/**
          **/deploy/**
          **/test_*.php
          **/*.log
          **/.env.example
          
    # 8. Retry con directorio alternativo si falla
    - name: ğŸ”„ Retry Deploy (Alternative Directory)
      if: steps.ftp-deploy.outcome == 'failure'
      id: ftp-retry
      continue-on-error: true
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: ${{ secrets.FTP_PORT || 21 }}
        server-dir: /
        local-dir: ./
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/README.md
          **/.github/**
          
    # 9. Determinar resultado del deploy
    - name: ğŸ“Š Deploy Result Analysis  
      run: |
        if [ "${{ steps.ftp-deploy.outcome }}" == "success" ]; then
          echo "âœ… FTP Deploy exitoso en /public_html/"
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
        elif [ "${{ steps.ftp-retry.outcome }}" == "success" ]; then
          echo "âœ… FTP Deploy exitoso en directorio raÃ­z /"
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ Ambos intentos de FTP fallaron"
          echo "DEPLOY_STATUS=failed" >> $GITHUB_ENV
        fi
        
    # 10. Health Check Post-Deploy (solo si deploy exitoso)
    - name: ğŸ¥ Post-Deploy Health Check
      if: env.DEPLOY_STATUS == 'success'
      run: |
        echo "ğŸ¥ Verificando despliegue..."
        echo "âœ… Archivos desplegados exitosamente"
        echo "ğŸŒ URL del sitio: https://valora.vip"
        echo "ğŸ“… Fecha de despliegue: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        
    # 11. Deploy Status Notification  
    - name: ğŸ“§ Deployment Status Notification
      if: always()
      run: |
        if [ "${{ env.DEPLOY_STATUS }}" == "success" ]; then
          echo "ğŸ‰ Â¡DESPLIEGUE EXITOSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Valora.vip desplegado correctamente"
          echo "ğŸŒ Sistema de autenticaciÃ³n: âœ“"
          echo "ğŸ“§ Sistema de email con PHPMailer: âœ“"  
          echo "ğŸ” RecuperaciÃ³n de contraseÃ±a: âœ“"
          echo "ğŸ—„ï¸ Base de datos: 9,321 usuarios"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "âŒ ERROR EN EL DESPLIEGUE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Problema: Credenciales FTP incorrectas"
          echo "ğŸ“‹ SoluciÃ³n: Verificar GitHub Secrets:"
          echo "   - FTP_HOST: IP o dominio del servidor"
          echo "   - FTP_USERNAME: Usuario FTP"  
          echo "   - FTP_PASSWORD: ContraseÃ±a FTP"
          echo "ğŸ†˜ Alternativas:"
          echo "   1. Verificar credenciales en hosting panel"
          echo "   2. Probar conexiÃ³n con FileZilla"
          echo "   3. Cambiar a SFTP si FTP no funciona"
          echo "   4. Deploy manual temporal"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi