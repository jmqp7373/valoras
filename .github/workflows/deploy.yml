name: ğŸš€ Deploy Valora.vip to Production

# Se ejecuta cuando hay push a la rama main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy to Production Server
    
    steps:
    # 1. Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup PHP Environment
    - name: ğŸ” Setup PHP Environment
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, gd
        
    # 3. Install Composer Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        composer install --no-dev --optimize-autoloader --no-interaction
        
    # 4. Validate PHP Syntax
    - name: ğŸ§ª Validate Code Quality
      run: |
        echo "ğŸ” Validando sintaxis PHP..."
        find . -name "*.php" -exec php -l {} \;
        echo "âœ… ValidaciÃ³n de sintaxis completada"
        
        echo "ğŸ“Š EstadÃ­sticas del proyecto:"
        echo "ğŸ“„ Archivos PHP: $(find . -name '*.php' | wc -l)"
        echo "ğŸ“ Directorios: $(find . -type d | wc -l)"
        echo "ğŸ“‹ Archivos totales: $(find . -type f | wc -l)"
        
    # 5. Prepare Deployment Files
    - name: ğŸ“ Prepare Files for Deployment
      run: |
        echo "ğŸ“‹ Archivos principales del sistema:"
        ls -la
        
        echo "ğŸ” Verificando estructura MVC:"
        echo "ğŸ“ Controllers: $(ls -1 controllers/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Models: $(ls -1 models/ 2>/dev/null | wc -l) archivos"  
        echo "ğŸ“ Views: $(ls -1 views/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Services: $(ls -1 services/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Config: $(ls -1 config/ 2>/dev/null | wc -l) archivos"
        
        echo "ï¿½ Verificando sistema de email:"
        [ -f "services/EmailService.php" ] && echo "âœ… EmailService.php encontrado" || echo "âŒ EmailService.php faltante"
        [ -f "config/email-config.php" ] && echo "âœ… email-config.php encontrado" || echo "âŒ email-config.php faltante"
        [ -d "vendor" ] && echo "âœ… Dependencias Composer encontradas" || echo "âŒ Directorio vendor faltante"
        
    # 6. Debug - Verificar secretos (sin mostrar valores reales)
    - name: ğŸ” Debug Connection Info
      run: |
        echo "ğŸ” Verificando configuraciÃ³n de deploy..."
        echo "ğŸ“¡ FTP Host configurado: $(echo '${{ secrets.FTP_HOST }}' | sed 's/./*/g')"
        echo "ğŸ‘¤ FTP User configurado: $(echo '${{ secrets.FTP_USERNAME }}' | sed 's/./*/g')"  
        echo "ğŸ” FTP Pass configurado: $(if [ -n '${{ secrets.FTP_PASSWORD }}' ]; then echo '***SET***'; else echo '***NOT SET***'; fi)"
        echo "ğŸ“ Directorio destino: /public_html/"
        echo "ğŸŒ Protocolo: FTP puerto 21"
        
    # 7. Deploy vÃ­a FTP (con mejor manejo de errores)
    - name: ğŸš€ Deploy to Production Server (FTP)
      id: ftp-deploy
      continue-on-error: true
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        server-dir: /public_html/
        local-dir: ./
        log-level: verbose
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/README.md
          **/.github/**
          **/deploy/**
          **/test_*.php
          **/*.log
          **/.env.example
          
    # 8. Retry con directorio alternativo si falla
    - name: ğŸ”„ Retry Deploy (Alternative Directory)
      if: steps.ftp-deploy.outcome == 'failure'
      id: ftp-retry
      continue-on-error: true
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        server-dir: /
        local-dir: ./
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/README.md
          **/.github/**
          
    # 9. Determinar resultado del deploy
    - name: ğŸ“Š Deploy Result Analysis  
      run: |
        if [ "${{ steps.ftp-deploy.outcome }}" == "success" ]; then
          echo "âœ… FTP Deploy exitoso en /public_html/"
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
        elif [ "${{ steps.ftp-retry.outcome }}" == "success" ]; then
          echo "âœ… FTP Deploy exitoso en directorio raÃ­z /"
          echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ Ambos intentos de FTP fallaron"
          echo "DEPLOY_STATUS=failed" >> $GITHUB_ENV
        fi
        
    # 10. Health Check Post-Deploy (solo si deploy exitoso)
    - name: ğŸ¥ Post-Deploy Health Check
      if: env.DEPLOY_STATUS == 'success'
      run: |
        echo "ğŸ¥ Verificando despliegue..."
        echo "âœ… Archivos desplegados exitosamente"
        echo "ğŸŒ URL del sitio: https://valora.vip"
        echo "ğŸ“… Fecha de despliegue: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        
    # 11. Deploy Status Notification  
    - name: ğŸ“§ Deployment Status Notification
      if: always()
      run: |
        if [ "${{ env.DEPLOY_STATUS }}" == "success" ]; then
          echo "ğŸ‰ Â¡DESPLIEGUE EXITOSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Valora.vip desplegado correctamente"
          echo "ğŸŒ Sistema de autenticaciÃ³n: âœ“"
          echo "ğŸ“§ Sistema de email con PHPMailer: âœ“"  
          echo "ğŸ” RecuperaciÃ³n de contraseÃ±a: âœ“"
          echo "ğŸ—„ï¸ Base de datos: 9,321 usuarios"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "âŒ ERROR EN EL DESPLIEGUE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Problema: Credenciales FTP incorrectas"
          echo "ğŸ“‹ SoluciÃ³n: Verificar GitHub Secrets:"
          echo "   - FTP_HOST: IP o dominio del servidor"
          echo "   - FTP_USERNAME: Usuario FTP"  
          echo "   - FTP_PASSWORD: ContraseÃ±a FTP"
          echo "ğŸ†˜ Alternativas:"
          echo "   1. Verificar credenciales en hosting panel"
          echo "   2. Probar conexiÃ³n con FileZilla"
          echo "   3. Cambiar a SFTP si FTP no funciona"
          echo "   4. Deploy manual temporal"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
          **/README.md
          **/.github/**
          **/deploy/**
          
    # 7. NotificaciÃ³n de Ã©xito
    - name: Deployment Success
      run: |
        echo "âœ… Deployment completado exitosamente!"
        echo "ğŸŒ Tu sitio web estÃ¡ disponible en valora.vip"
        echo "ğŸ“„ Archivos subidos: index.php, index.html, info.php, .htaccess"