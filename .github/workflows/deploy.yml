name: ğŸš€ Deploy Valora.vip to Production

# Se ejecuta cuando hay push a la rama main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy to Production Server
    
    steps:
    # 1. Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup PHP Environment
    - name: ğŸ” Setup PHP Environment
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, gd
        
    # 3. Install Composer Dependencies
    - name: ğŸ“¦ Install Dependencies
      run: |
        composer install --no-dev --optimize-autoloader --no-interaction
        
    # 4. Validate PHP Syntax
    - name: ğŸ§ª Validate Code Quality
      run: |
        echo "ğŸ” Validando sintaxis PHP..."
        find . -name "*.php" -exec php -l {} \;
        echo "âœ… ValidaciÃ³n de sintaxis completada"
        
        echo "ğŸ“Š EstadÃ­sticas del proyecto:"
        echo "ğŸ“„ Archivos PHP: $(find . -name '*.php' | wc -l)"
        echo "ğŸ“ Directorios: $(find . -type d | wc -l)"
        echo "ğŸ“‹ Archivos totales: $(find . -type f | wc -l)"
        
    # 5. Prepare Deployment Files
    - name: ğŸ“ Prepare Files for Deployment
      run: |
        echo "ğŸ“‹ Archivos principales del sistema:"
        ls -la
        
        echo "ğŸ” Verificando estructura MVC:"
        echo "ğŸ“ Controllers: $(ls -1 controllers/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Models: $(ls -1 models/ 2>/dev/null | wc -l) archivos"  
        echo "ğŸ“ Views: $(ls -1 views/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Services: $(ls -1 services/ 2>/dev/null | wc -l) archivos"
        echo "ğŸ“ Config: $(ls -1 config/ 2>/dev/null | wc -l) archivos"
        
        echo "ï¿½ Verificando sistema de email:"
        [ -f "services/EmailService.php" ] && echo "âœ… EmailService.php encontrado" || echo "âŒ EmailService.php faltante"
        [ -f "config/email-config.php" ] && echo "âœ… email-config.php encontrado" || echo "âŒ email-config.php faltante"
        [ -d "vendor" ] && echo "âœ… Dependencias Composer encontradas" || echo "âŒ Directorio vendor faltante"
        
    # 6. Deploy vÃ­a FTP
    - name: ğŸš€ Deploy to Production Server
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        server-dir: /public_html/
        local-dir: ./
        log-level: verbose
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.vscode/**
          **/README.md
          **/.github/**
          **/deploy/**
          **/test_*.php
          **/*.log
          **/.env.example
          
    # 7. Health Check Post-Deploy
    - name: ğŸ¥ Post-Deploy Health Check
      run: |
        echo "ğŸ¥ Verificando despliegue..."
        echo "âœ… Archivos desplegados exitosamente"
        echo "ğŸŒ URL del sitio: https://valora.vip"
        echo "ğŸ“… Fecha de despliegue: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Autor: ${{ github.actor }}"
        
    # 8. Deploy Status Notification  
    - name: ğŸ“§ Deployment Status Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Â¡DESPLIEGUE EXITOSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Valora.vip desplegado correctamente"
          echo "ğŸŒ Sistema de autenticaciÃ³n: âœ“"
          echo "ğŸ“§ Sistema de email con PHPMailer: âœ“"  
          echo "ğŸ” RecuperaciÃ³n de contraseÃ±a: âœ“"
          echo "ğŸ—„ï¸ Base de datos: 9,321 usuarios"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "âŒ ERROR EN EL DESPLIEGUE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Revisar logs de GitHub Actions"
          echo "âš ï¸ El sitio puede estar inaccesible"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
          **/README.md
          **/.github/**
          **/deploy/**
          
    # 7. NotificaciÃ³n de Ã©xito
    - name: Deployment Success
      run: |
        echo "âœ… Deployment completado exitosamente!"
        echo "ğŸŒ Tu sitio web estÃ¡ disponible en valora.vip"
        echo "ğŸ“„ Archivos subidos: index.php, index.html, info.php, .htaccess"